<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CryptoPOS Secure UI</title>
    <style>
      /* --- DARK MODE & THEME VARIABLES --- */
      :root {
        --bg-color: #f4f6f9;
        --text-color: #333;
        --card-bg: #ffffff;
        --input-bg: #ffffff;
        --input-border: #eef2f7;
        --primary-color: #007bff;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }

      body.dark-mode {
        --bg-color: #121212;
        --text-color: #e0e0e0;
        --card-bg: #1e1e1e;
        --input-bg: #2d2d2d;
        --input-border: #444;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        text-align: center;
        padding: 20px;
        transition:
          background 0.3s,
          color 0.3s;
      }

      /* Theme Toggle Button */
      .theme-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: var(--card-bg);
        border: 2px solid var(--input-border);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* Screen Container */
      .screen {
        background: var(--card-bg);
        max-width: 480px;
        margin: 40px auto; /* Added more top margin */
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: var(--shadow);
        display: none;
        transition: all 0.3s;
        border: 1px solid var(--input-border);
      }

      .active {
        display: block;
        animation: slideUp 0.4s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h2 {
        margin-bottom: 25px;
        font-weight: 800;
        letter-spacing: -0.5px;
      }

      /* BIG INPUT STYLE (New Improvement) */
      .big-input-group {
        margin-bottom: 25px;
        text-align: left;
      }
      .input-label {
        font-size: 14px;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 8px;
        display: block;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      input {
        width: 100%;
        padding: 15px;
        margin: 5px 0;
        border: 2px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text-color);
        border-radius: 12px;
        font-size: 18px; /* Bigger Text */
        box-sizing: border-box;
        transition: 0.3s;
      }

      /* Special Style for Money Input */
      #billAmount {
        font-size: 32px; /* Massive Font */
        font-weight: bold;
        text-align: center;
        border-color: var(--primary-color);
        padding: 20px;
      }

      input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
      }

      /* Buttons */
      .btn-main {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        transition: 0.2s;
      }
      .btn-main:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
      }
      .btn-sec {
        background: var(--input-border);
        color: var(--text-color);
        box-shadow: none;
      }
      .btn-sec:hover {
        background: #ced4da;
      }

      /* Coin Selection Chips */
      .coin-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
      }
      .coin-btn {
        padding: 12px 5px;
        border: 2px solid var(--input-border);
        border-radius: 12px;
        cursor: pointer;
        background: var(--input-bg);
        font-weight: 600;
        color: var(--text-color);
        transition: 0.2s;
        text-align: center;
        font-size: 14px;
      }
      .coin-btn:hover {
        border-color: var(--primary-color);
      }
      .coin-btn.selected {
        background: rgba(0, 123, 255, 0.1);
        color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 800;
      }

      /* Pay Cards */
      .pay-card {
        border: 2px solid var(--input-border);
        padding: 20px;
        border-radius: 16px;
        margin: 15px 0;
        cursor: pointer;
        text-align: left;
        position: relative;
        background: var(--input-bg);
        transition: 0.2s;
      }
      .pay-card:hover {
        border-color: var(--primary-color);
        transform: scale(1.02);
      }
      .amount-big {
        font-size: 1.4em;
        font-weight: 800;
        margin: 5px 0;
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8); /* Darker overlay */
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
      }
      .modal-box {
        background: var(--card-bg);
        color: var(--text-color);
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 350px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }
      .modal-btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn-modal {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      /* Search Results */
      #searchResults {
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
        background: var(--card-bg);
        position: absolute;
        width: 100%;
        left: 0;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: none;
        z-index: 100;
        top: 100%;
        border: 1px solid var(--input-border);
      }
      .coin-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--input-border);
        display: flex;
        align-items: center;
        color: var(--text-color);
      }
      .coin-item:hover {
        background: var(--input-border);
      }
      .coin-item img {
        width: 25px;
        margin-right: 12px;
        border-radius: 50%;
      }

      /* RECEIPT STYLES */
      #receipt-area {
        display: none;
        background: white; /* Receipt always white */
        color: black;
        padding: 30px;
        border: 2px dashed #333;
        text-align: left;
        max-width: 400px;
        margin: 20px auto;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        #receipt-area,
        #receipt-area * {
          visibility: visible;
        }
        #receipt-area {
          position: absolute;
          left: 50%;
          transform: translateX(-50%);
          top: 20px;
          width: 400px;
          border: none;
          padding: 0;
        }
        .no-print {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Switch Theme">
      üåô
    </button>

    <div id="custom-alert" class="modal-overlay">
      <div class="modal-box">
        <span class="modal-icon" style="font-size: 40px">‚ö†Ô∏è</span>
        <div
          class="modal-title"
          id="alert-title"
          style="font-size: 20px; font-weight: bold; margin: 10px 0"
        >
          Notice
        </div>
        <div class="modal-msg" id="alert-msg">Something went wrong</div>
        <button class="btn-modal btn-sec" onclick="closeAlert()">Okay</button>
      </div>
    </div>

    <div id="password-modal" class="modal-overlay">
      <div class="modal-box">
        <span style="font-size: 40px">üîí</span>
        <h3>Admin Access</h3>
        <p>Enter PIN</p>
        <input
          type="password"
          id="adminPassInput"
          placeholder="PIN"
          style="text-align: center"
        />
        <div class="modal-btn-group">
          <button class="btn-modal btn-sec" onclick="closePassModal()">
            Cancel
          </button>
          <button
            class="btn-modal btn-main"
            style="margin-top: 0"
            onclick="submitPassword()"
          >
            Login
          </button>
        </div>
      </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
      <div class="modal-box">
        <span style="font-size: 40px">ü§î</span>
        <h3>Confirm Payment?</h3>
        <p id="confirm-msg">Proceed with this plan?</p>
        <div
          style="
            background: var(--input-border);
            padding: 10px;
            border-radius: 10px;
            text-align: left;
            margin: 10px 0;
          "
        >
          Plan: <strong id="conf-plan">---</strong><br />
          Amount: <strong id="conf-amount" style="color: #007bff">---</strong>
        </div>
        <div class="modal-btn-group">
          <button class="btn-modal btn-sec" onclick="closeConfirmModal()">
            No
          </button>
          <button
            class="btn-modal btn-main"
            style="margin-top: 0"
            onclick="executeTransaction()"
          >
            Yes, Pay
          </button>
        </div>
      </div>
    </div>

    <div id="seller-screen" class="screen active">
      <h2>üè™ Merchant POS</h2>

      <div class="big-input-group">
        <label class="input-label">Bill Amount (LKR)</label>
        <input type="number" id="billAmount" placeholder="0.00" autofocus />
      </div>

      <div class="big-input-group">
        <label class="input-label">Select Currency</label>
        <div class="coin-grid">
          <div class="coin-btn" onclick="quickSelect('bitcoin', this)">BTC</div>
          <div class="coin-btn" onclick="quickSelect('ethereum', this)">
            ETH
          </div>
          <div class="coin-btn" onclick="quickSelect('solana', this)">SOL</div>
          <div class="coin-btn" onclick="quickSelect('tether', this)">USDT</div>
        </div>

        <div style="position: relative">
          <input
            type="text"
            id="coinSearch"
            placeholder="üîç Search other coins..."
            onkeyup="searchCoins()"
            style="font-size: 16px; padding: 12px; text-align: left"
          />
          <div id="searchResults"></div>
        </div>

        <div
          id="selName"
          style="
            color: var(--primary-color);
            margin-top: 5px;
            font-weight: 600;
            min-height: 20px;
            font-size: 14px;
          "
        ></div>
      </div>

      <button class="btn-main" onclick="generateQR()">
        GENERATE QR CODE üèÅ
      </button>

      <p
        id="loading-txt"
        style="
          display: none;
          color: var(--primary-color);
          font-weight: bold;
          margin-top: 15px;
          animation: blink 1s infinite;
        "
      >
        ‚è≥ Processing...
      </p>

      <p
        onclick="openPassModal()"
        style="margin-top: 30px; cursor: pointer; font-size: 13px; opacity: 0.6"
      >
        üõ°Ô∏è Admin Dashboard
      </p>
    </div>

    <div id="customer-screen" class="screen">
      <h2>üì± Customer View</h2>
      <center>
        <div
          style="
            background: white;
            padding: 10px;
            border-radius: 15px;
            display: inline-block;
          "
        >
          <img id="qrImage" src="" width="150" style="display: block" />
        </div>
      </center>
      <p style="margin-top: 10px; opacity: 0.8">
        Paying with <strong id="payCoinName"></strong>
      </p>

      <div class="pay-card" onclick="askConfirmation('Pay Now')">
        <div style="display: flex; justify-content: space-between">
          <h3>üöÄ Pay Full</h3>
          <span
            style="
              background: #fff3cd;
              color: #856404;
              font-size: 11px;
              padding: 4px 8px;
              border-radius: 50px;
              height: fit-content;
            "
            >Fee: 1%</span
          >
        </div>
        <div class="amount-big">Rs. <span id="nowLKR"></span></div>
        <small style="color: var(--primary-color)"
          ><span id="nowCrypto"></span> <span id="nowCoinSymbol"></span
        ></small>
      </div>

      <div class="pay-card" onclick="askConfirmation('Installment')">
        <div style="display: flex; justify-content: space-between">
          <h3>üìÖ 3-Month Plan</h3>
          <span
            style="
              background: #f8d7da;
              color: #721c24;
              font-size: 11px;
              padding: 4px 8px;
              border-radius: 50px;
              height: fit-content;
            "
            >Fee: 10%</span
          >
        </div>
        <div class="amount-big">
          Rs. <span id="instMonthly"></span> <small>/mo</small>
        </div>
        <div
          class="schedule-box"
          id="scheduleList"
          style="margin-top: 10px; font-size: 13px; color: var(--text-color)"
        ></div>
      </div>

      <button
        class="btn-main btn-sec"
        onclick="location.reload()"
        style="color: #dc3545"
      >
        Cancel
      </button>
    </div>

    <div id="admin-screen" class="screen">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <h2>üìä Dashboard</h2>
        <button
          onclick="location.reload()"
          style="
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
          "
        >
          ‚úï
        </button>
      </div>
      <div
        style="
          background: linear-gradient(135deg, #343a40, #212529);
          color: white;
          padding: 20px;
          border-radius: 15px;
        "
      >
        <p>Total Income</p>
        <h1 id="adminRevenue" style="margin: 0; font-size: 2.5em">0.00</h1>
      </div>
      <h4 style="text-align: left; margin-top: 25px">Recent Transactions</h4>
      <div id="salesList" style="text-align: left; margin-top: 10px"></div>
      <button class="btn-main btn-sec" onclick="location.reload()">
        Log Out
      </button>
    </div>

    <div id="receipt-area">
      <center>
        <h3 style="margin: 0">‚úÖ PAYMENT SUCCESS</h3>
        CryptoPay Gateway<br />----------------
      </center>
      <p><b>Date:</b> <span id="rDate"></span></p>
      <p><b>Item Price:</b> Rs. <span id="rOriginal"></span></p>
      <div
        id="receipt-schedule"
        style="
          margin: 15px 0;
          border-top: 1px dashed #aaa;
          border-bottom: 1px dashed #aaa;
          padding: 15px 0;
        "
      ></div>
      <p style="font-size: 1.2em">
        <b>Total Paid Today:</b><br />Rs. <span id="rPaidNow"></span>
      </p>
      <center>----------------<br />Thank You!</center>
      <div class="no-print" style="text-align: center; margin-top: 20px">
        <button
          onclick="window.print()"
          class="btn-main"
          style="width: auto; padding: 10px 30px"
        >
          üñ®Ô∏è Print Receipt</button
        ><br /><br />
        <button
          onclick="location.reload()"
          style="
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
          "
        >
          New Order
        </button>
      </div>
    </div>

    <script>
      // --- THEME TOGGLE FUNCTION ---
      function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        const btn = document.querySelector(".theme-toggle");
        btn.innerHTML = document.body.classList.contains("dark-mode")
          ? "‚òÄÔ∏è"
          : "üåô";
      }

      // --- EXISTING LOGIC ---
      let selectedCoinId = "";
      let paymentData = {};
      let pendingPlan = "";

      function showAlert(title, msg, type = "error") {
        document.getElementById("alert-title").innerText = title;
        document.getElementById("alert-msg").innerText = msg;
        document.getElementById("custom-alert").style.display = "flex";
      }
      function closeAlert() {
        document.getElementById("custom-alert").style.display = "none";
      }

      function openPassModal() {
        document.getElementById("password-modal").style.display = "flex";
        document.getElementById("adminPassInput").value = "";
        document.getElementById("adminPassInput").focus();
      }
      function closePassModal() {
        document.getElementById("password-modal").style.display = "none";
      }

      async function submitPassword() {
        const password = document.getElementById("adminPassInput").value;
        if (!password) return;
        const res = await fetch("/api/admin-stats", {
          headers: { "x-admin-password": password },
        });
        if (res.status === 401) {
          closePassModal();
          showAlert("Access Denied", "Incorrect Password!", "error");
          return;
        }
        const data = await res.json();
        document.getElementById("adminRevenue").innerText =
          "Rs. " + data.totalIncome;
        document.getElementById("salesList").innerHTML = data.recentSales
          .map(
            (s) =>
              `<div style="border-bottom:1px solid #eee; padding:10px 0; font-size:14px; display:flex; justify-content:space-between;">
             <span>${new Date(s.time).toLocaleTimeString()}</span> <span><b>${s.coin.toUpperCase()}</b></span> <span>Rs.${s.amount}</span>
           </div>`,
          )
          .join("");
        closePassModal();
        document.querySelector(".active").classList.remove("active");
        document.getElementById("admin-screen").classList.add("active");
      }

      function askConfirmation(plan) {
        pendingPlan = plan;
        const isInst = plan === "Installment";
        const amount = isInst
          ? paymentData.options.installments.monthlyPayment
          : paymentData.options.payNow.lkrTotal;
        document.getElementById("conf-plan").innerText = isInst
          ? "3-Month Plan"
          : "Full Payment";
        document.getElementById("conf-amount").innerText = "Rs. " + amount;
        document.getElementById("confirm-modal").style.display = "flex";
      }
      function closeConfirmModal() {
        document.getElementById("confirm-modal").style.display = "none";
      }
      function executeTransaction() {
        completePayment(pendingPlan);
        closeConfirmModal();
      }

      function quickSelect(id, btn) {
        selectedCoinId = id;
        document
          .querySelectorAll(".coin-btn")
          .forEach((b) => b.classList.remove("selected"));
        btn.classList.add("selected");
        document.getElementById("selName").innerText =
          id.toUpperCase() + " Selected";
      }

      async function searchCoins() {
        const q = document.getElementById("coinSearch").value;
        const r = document.getElementById("searchResults");
        if (q.length < 2) {
          r.style.display = "none";
          return;
        }
        try {
          const res = await fetch(`/api/search?q=${q}`);
          const d = await res.json();
          r.innerHTML = "";
          r.style.display = "block";
          d.forEach((c) => {
            const div = document.createElement("div");
            div.className = "coin-item";
            div.innerHTML = `<img src="${c.thumb}"> ${c.name}`;
            div.onclick = () => {
              quickSelect(c.id, { classList: { add: () => {} } });
              r.style.display = "none";
              document.getElementById("coinSearch").value = "";
            };
            r.appendChild(div);
          });
        } catch (e) {}
      }

      async function generateQR() {
        const amt = document.getElementById("billAmount").value;
        if (!amt || amt <= 0) {
          showAlert("Invalid", "Check Amount");
          return;
        }
        if (!selectedCoinId) {
          showAlert("No Coin", "Select Coin");
          return;
        }

        document.getElementById("loading-txt").style.display = "block";
        try {
          const res = await fetch(
            `/api/calculate-payment?amount=${amt}&coin=${selectedCoinId}`,
          );
          if (!res.ok) throw new Error();
          paymentData = await res.json();

          document.getElementById("payCoinName").innerText =
            paymentData.coin.toUpperCase();
          document.getElementById("qrImage").src =
            `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Pay_${paymentData.coin}`;
          document.getElementById("nowLKR").innerText =
            paymentData.options.payNow.lkrTotal;
          document.getElementById("nowCrypto").innerText =
            paymentData.options.payNow.cryptoTotal;
          document.getElementById("nowCoinSymbol").innerText =
            paymentData.coin.toUpperCase();
          document.getElementById("instMonthly").innerText =
            paymentData.options.installments.monthlyPayment;

          const schedBox = document.getElementById("scheduleList");
          schedBox.innerHTML = "";
          paymentData.options.installments.schedule.forEach((item, i) => {
            schedBox.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; ${i === 0 ? "color:green; font-weight:bold" : ""}">
                <span>${item.date}</span> <span>Rs. ${item.amountLKR}</span>
             </div>`;
          });

          document.getElementById("loading-txt").style.display = "none";
          document.querySelector(".active").classList.remove("active");
          document.getElementById("customer-screen").classList.add("active");
        } catch (err) {
          document.getElementById("loading-txt").style.display = "none";
          showAlert("Error", "Connection Failed");
        }
      }

      async function completePayment(type) {
        const isInst = type === "Installment";
        const paidAmount = isInst
          ? paymentData.options.installments.monthlyPayment
          : paymentData.options.payNow.lkrTotal;
        await fetch(
          `/api/record-sale?amount=${paidAmount}&coin=${paymentData.coin}&plan=${type}`,
        );

        document.getElementById("rDate").innerText =
          new Date().toLocaleString();
        document.getElementById("rOriginal").innerText =
          document.getElementById("billAmount").value;
        document.getElementById("rPaidNow").innerText = paidAmount;

        const recSched = document.getElementById("receipt-schedule");
        if (isInst) {
          recSched.innerHTML = "<b>PLAN: 3-Month Installment</b><br><br>";
          paymentData.options.installments.schedule.forEach((item, i) => {
            recSched.innerHTML += `<div>${item.date}: Rs. ${item.amountLKR} ${i === 0 ? "(PAID)" : ""}</div>`;
          });
        } else {
          recSched.innerHTML = "<b>METHOD: One-time Full Payment</b>";
        }

        document.getElementById("customer-screen").classList.remove("active");
        document.getElementById("receipt-area").style.display = "block";
      }
    </script>
  </body>
</html>